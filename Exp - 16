# ---------------------------------------------------------
# Hyperparameter Tuning of a Neural Network (MLP) using Keras
# Dataset: Breast Cancer
# ---------------------------------------------------------

import numpy as np
from sklearn.datasets import load_breast_cancer
from sklearn.model_selection import train_test_split, GridSearchCV
from sklearn.preprocessing import StandardScaler
from sklearn.metrics import accuracy_score

from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Dense
from tensorflow.keras.wrappers.scikit_learn import KerasClassifier

# ---------------------------------------------------------
# Load Dataset
# ---------------------------------------------------------
data = load_breast_cancer()
X = data.data
y = data.target

# Standardize
sc = StandardScaler()
X = sc.fit_transform(X)

# ---------------------------------------------------------
# Train-Test Split
# ---------------------------------------------------------
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.25, random_state=42
)

# ---------------------------------------------------------
# Function to Build the Neural Network
# ---------------------------------------------------------
def build_model(neurons=16, activation='relu', optimizer='adam'):
    model = Sequential()
    model.add(Dense(neurons, activation=activation, input_dim=X.shape[1]))
    model.add(Dense(neurons, activation=activation))
    model.add(Dense(1, activation='sigmoid'))  # Binary classification
    model.compile(optimizer=optimizer, loss='binary_crossentropy', metrics=['accuracy'])
    return model

# Use KerasClassifier wrapper
model = KerasClassifier(build_fn=build_model, verbose=0)

# ---------------------------------------------------------
# Hyperparameter Space
# ---------------------------------------------------------
param_grid = {
    'neurons': [8, 16, 32],
    'activation': ['relu', 'tanh'],
    'optimizer': ['adam', 'sgd'],
    'batch_size': [16, 32],
    'epochs': [30, 50]
}

# ---------------------------------------------------------
# Grid Search for Best Hyperparameters
# ---------------------------------------------------------
grid = GridSearchCV(estimator=model, param_grid=param_grid, cv=3, n_jobs=-1)
grid_result = grid.fit(X_train, y_train)

# ---------------------------------------------------------
# Best Hyperparameters & Accuracy
# ---------------------------------------------------------
print("\nBest Hyperparameters:")
print(grid_result.best_params_)

print("\nBest Cross-Validation Accuracy:", grid_result.best_score_)

# ---------------------------------------------------------
# Evaluate on Test Set
# ---------------------------------------------------------
best_model = grid_result.best_estimator_
y_pred = (best_model.predict(X_test) > 0.5).astype("int32")

print("\nTest Accuracy:", accuracy_score(y_test, y_pred))
